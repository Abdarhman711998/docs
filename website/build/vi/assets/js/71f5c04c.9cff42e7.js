"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1578],{20819:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var i=t(85893),o=t(11151);const a={id:"index-functions",title:"Indexing Functions",sidebar_label:"Indexing Functions"},r=void 0,s={id:"build/data-infrastructure/query-api/index-functions",title:"Indexing Functions",description:"QueryAPI is a fully managed service that allows you to create and manage indexers on-chain seamlessly.",source:"@site/../docs/2.build/6.data-infrastructure/query-api/index-function.md",sourceDirName:"2.build/6.data-infrastructure/query-api",slug:"/build/data-infrastructure/query-api/index-functions",permalink:"/vi/build/data-infrastructure/query-api/index-functions",draft:!1,unlisted:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/2.build/6.data-infrastructure/query-api/index-function.md",tags:[],version:"current",lastUpdatedBy:"gagdiez",lastUpdatedAt:1712759479e3,frontMatter:{id:"index-functions",title:"Indexing Functions",sidebar_label:"Indexing Functions"},sidebar:"build",previous:{title:"Best Practices",permalink:"/vi/build/data-infrastructure/query-api/best-practices"},next:{title:"Context object",permalink:"/vi/build/data-infrastructure/query-api/context-object"}},c={},l=[{value:"Indexing",id:"indexing",level:2},{value:"Local Debug Mode",id:"local-debug-mode",level:2},{value:"Contract filters",id:"contract-filters",level:2},{value:"Single contract filter",id:"single-contract-filter",level:4},{value:"Multiple contracts filter",id:"multiple-contracts-filter",level:4},{value:"Feed-indexer logic",id:"feed-indexer-logic",level:2},{value:"Mutations in GraphQL",id:"mutations-in-graphql",level:2},{value:"Create a NEAR component from query",id:"create-a-near-component-from-query",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"QueryAPI is a fully managed service that allows you to create and manage indexers on-chain seamlessly."})}),"\n",(0,i.jsx)(n.h2,{id:"indexing",children:"Indexing"}),"\n",(0,i.jsxs)(n.p,{children:["Let's review a ",(0,i.jsx)(n.a,{href:"https://near.org/dataplatform.near/widget/QueryApi.App?selectedIndexerPath=roshaan.near/demo-indexer",children:"very simple indexer"}),", which will help you to understand\nhow the indexer's indexing logic works."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",metastring:"title=indexingLogic.js",children:'import { Block } from "@near-lake/primitives";\n\n/**\n * getBlock(block, context) applies your custom logic to a Block on Near and commits the data to a database.\n *\n * @param {block} Block - A Near Protocol Block\n * @param {context} - A set of helper methods to retrieve and commit state\n */\nasync function getBlock(block: Block, context) {\n  const h = block.header().height;\n  await context.set("height", h);\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In the ",(0,i.jsx)(n.code,{children:"getBlock()"})," function, you're given a block, which is a block on the Near blockchain, as\nwell as a ",(0,i.jsx)(n.code,{children:"context"})," object, which gives you a set of helper methods to be able to commit\nwhat you want to the database that QueryAPI has provisioned for you."]}),"\n",(0,i.jsxs)(n.p,{children:["The code is going into the header of the ",(0,i.jsx)(n.code,{children:"block"}),"\nand getting the block's ",(0,i.jsx)(n.code,{children:"height"}),", and then is using the ",(0,i.jsx)(n.code,{children:"context"})," object to set a key value store."]}),"\n",(0,i.jsx)(n.p,{children:"Next, if you check out the database schema:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",metastring:"title=schema.sql",children:'CREATE TABLE\n  "indexer_storage" (\n    "function_name" TEXT NOT NULL,\n    "key_name" TEXT NOT NULL,\n    "value" TEXT NOT NULL,\n    PRIMARY KEY ("function_name", "key_name")\n  )\n'})}),"\n",(0,i.jsxs)(n.p,{children:["It's a very simple schema where you can store the ",(0,i.jsx)(n.code,{children:"function_name"}),", ",(0,i.jsx)(n.code,{children:"key_name"}),", and ",(0,i.jsx)(n.code,{children:"value"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["That's all this indexer function is doing: it sets the ",(0,i.jsx)(n.code,{children:"height"})," value equal to the current block's height."]})}),"\n",(0,i.jsx)(n.h2,{id:"local-debug-mode",children:"Local Debug Mode"}),"\n",(0,i.jsxs)(n.p,{children:["While you're iterating on your indexer development, it's critical to have some type of debugging\nfunctionality to be able to test with, and the ",(0,i.jsx)(n.em,{children:"Debug Mode"})," is very helpful for that."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"QueryAPI Dashboard",src:t(99223).Z+"",width:"2692",height:"956"})}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you want to test the ",(0,i.jsx)(n.a,{href:"#indexing",children:"simple indexer"})," explained in the previous section\nusing the local debugging mode:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Enable ",(0,i.jsx)("kbd",{children:"Debug Mode"})," on the ",(0,i.jsx)(n.strong,{children:"Indexer Editor"})]}),"\n",(0,i.jsxs)(n.li,{children:["Add a block to your debug list (e.g., ",(0,i.jsx)(n.code,{children:"97779559"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Go into your web browser's Console"}),"\n",(0,i.jsxs)(n.li,{children:["Finally, click ",(0,i.jsx)("kbd",{children:"Play"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["On your browser's Console, you should see the indexer's debug execution where it sets the ",(0,i.jsx)(n.code,{children:"height"})," key to ",(0,i.jsx)(n.code,{children:"97779559"}),":"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"QueryAPI Indexer Dashboard",src:t(16147).Z+"",width:"1590",height:"384"})}),"\n",(0,i.jsx)(n.admonition,{title:"Local tests",type:"info",children:(0,i.jsxs)(n.p,{children:["All debug mode tests are happening ",(0,i.jsx)(n.strong,{children:"locally"}),", so they do not reach the database.\nAll your queries and mutations will return empty objects."]})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["You can also click ",(0,i.jsx)("kbd",{children:"Follow the Network"})," and it will show how your indexer logic works throughout."]})}),"\n",(0,i.jsx)(n.h2,{id:"contract-filters",children:"Contract filters"}),"\n",(0,i.jsx)(n.p,{children:"A contract filter is used by QueryAPI to do backend optimizations to\nhelp do historical indexing faster.\nWhile creating an indexer, when you define a contract filter,\nQueryAPI will send any single transaction event that passes this filter to your indexer function\nso you can index it."}),"\n",(0,i.jsxs)(n.p,{children:["If you only want to index events from a single contract, simply define the contract name on the ",(0,i.jsx)(n.strong,{children:"Contract Filter"})," text box.\nIn some cases you might want to either support indexing on multiple contracts,\nor simply support every single contract that exists on the Near blockchain."]}),"\n",(0,i.jsx)(n.h4,{id:"single-contract-filter",children:"Single contract filter"}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you check out the ",(0,i.jsx)(n.a,{href:"https://near.org/dataplatform.near/widget/QueryApi.App?selectedIndexerPath=roshaan.near/demo-indexer",children:"simple indexer"}),", you'll see that in this case\nyou have a ",(0,i.jsx)(n.code,{children:"social.near"})," contract filter.\nIn this example, the indexer is only concerned on indexing events from ",(0,i.jsx)(n.code,{children:"social.near"}),"'s contract."]}),"\n",(0,i.jsx)(n.h4,{id:"multiple-contracts-filter",children:"Multiple contracts filter"}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you want to index all the contracts from AstroDAO, where there is an account created\nfor each and every different DAO, you should define ",(0,i.jsx)(n.code,{children:"*.sputnik-dao.near"})," as the contract filter.\nLikewise, if you want to get events from every contract on the blockchain, simply define ",(0,i.jsx)(n.code,{children:"*"})," as the filter."]}),"\n",(0,i.jsx)(n.h2,{id:"feed-indexer-logic",children:"Feed-indexer logic"}),"\n",(0,i.jsx)(n.p,{children:"Then we call context.graphql, which allows us to make arbitrary mutations and queries\nto our database that we provision for you.\nIf you're interested in how to create GraphQL queries, there's a whole bunch of resources\nonline.\nIn this case, we are passing in our mutation data, which has a post object, and it's inserting\nit inside Postgres, I mean, inside of Postgres using GraphQL.\nBut it's very easy to create these mutations."}),"\n",(0,i.jsx)(n.h2,{id:"mutations-in-graphql",children:"Mutations in GraphQL"}),"\n",(0,i.jsx)(n.p,{children:"If you go to the GraphiQL tab, you can access the GraphiQL Explorer that provides a user friendly GraphQL playground, where you can view and create queries and mutations based on the DB schema that you defined for the indexer."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"QueryAPI Indexer Dashboard",src:t(47455).Z+"",width:"2100",height:"940"})}),"\n",(0,i.jsx)(n.p,{children:"You can easily set some fields and select the returning data\nthat you want, and the tool will build a query on the mutation panel on the right.\nThen you can copy the resulting query, either in your JavaScript code so that you pass actual\ndata manually, or you pass in the mutation data object as a second parameter."}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you go and add a new mutation, click ",(0,i.jsx)("kbd",{children:"+"}),", then you can do a bunch of actions here, such as creating, deleting, or inserting posts into your table."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Playground",src:t(54356).Z+"",width:"2560",height:"1374"})}),"\n",(0,i.jsxs)(n.p,{children:["If you want to test your mutation, using ",(0,i.jsx)(n.a,{href:"#local-debug-mode",children:"Debug Mode"})," you can add a specific\nblock to the list, and then play it to see how it works.\nBased on the indexer logic you defined, you'll get a call to the GraphQL mutation with the object\nand data passed into it."]}),"\n",(0,i.jsx)(n.admonition,{title:"Video Walkthrough",type:"tip",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Tip:"})," watch the video on how to ",(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=VwO6spk8D58&t=781s",children:"create mutations in GraphQL"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"create-a-near-component-from-query",children:"Create a NEAR component from query"}),"\n",(0,i.jsx)(n.p,{children:"Creating a NEAR component from a GraphQL query is simple when using the GraphQL Playground. Just follow these steps:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"go to the GraphiQL tab"}),"\n",(0,i.jsx)(n.li,{children:"select the query that you want to use"}),"\n",(0,i.jsxs)(n.li,{children:["click on the ",(0,i.jsx)("kbd",{children:"Show GraphiQL Code Exporter"})," button"]}),"\n",(0,i.jsx)(n.li,{children:"get some default code here, copy it,"}),"\n",(0,i.jsx)(n.li,{children:"go to the NEAR sandbox, paste it."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This will set up some boilerplate code to execute the GraphQL query, add the query that you had\nin your playground and then call that query, extract the data and render it using the\nrender data function."}),"\n",(0,i.jsxs)(n.p,{children:["Once you have the NEAR component code, you can test it out by going to ",(0,i.jsx)(n.a,{href:"https://near.org/sandbox",children:"the sandbox"}),",\npasting the generated code, and then selecting ",(0,i.jsx)("kbd",{children:"Component Preview"}),".\nNext, you can create a nice UI over this boilerplate code, and publish your new NEAR component."]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},54356:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/QAPIScreen-03cb0756572d56815b027f3ed320ab00.gif"},99223:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/QAPIdebug-3b3feca48be98705da3a6a8a2622cce2.png"},16147:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/QAPIdebuglog-cf19b914898beae84ead0c8784849fe5.png"},47455:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/QAPIgraphiql-18e6ea0aaae4a46fc6a84c7020f54397.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>r});var i=t(67294);const o={},a=i.createContext(o);function r(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);