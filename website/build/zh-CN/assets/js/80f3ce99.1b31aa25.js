"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4295],{78641:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>f,frontMatter:()=>o,metadata:()=>u,toc:()=>h});var r=a(85893),t=a(11151),s=a(74866),i=a(85162),l=a(77229);const o={sidebar_position:5},c="Serialization Protocols",u={id:"sdk/rust/contract-interface/serialization-interface",title:"Serialization Protocols",description:"Serialization formats within the SDK define how data structures are translated into bytes which are needed for passing data into methods of the smart contract or storing data in state. For the case of method parameters, JSON (default) and Borsh are supported with the SDK and for storing data on-chain Borsh is used.",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/sdk/rust/contract-interface/serialization-interface.md",sourceDirName:"sdk/rust/contract-interface",slug:"/sdk/rust/contract-interface/serialization-interface",permalink:"/zh-CN/sdk/rust/contract-interface/serialization-interface",draft:!1,unlisted:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/sdk/rust/contract-interface/serialization-interface.md",tags:[],version:"current",lastUpdatedBy:"Github Actions",lastUpdatedAt:1705914809e3,sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tools",previous:{title:"Payable Methods",permalink:"/zh-CN/sdk/rust/contract-interface/payable-methods"},next:{title:"Callbacks",permalink:"/zh-CN/sdk/rust/cross-contract/callbacks"}},d={},h=[{value:"Overriding Serialization Protocol Default",id:"overriding-serialization-protocol-default",level:3},{value:"Example",id:"example",level:4},{value:"JSON wrapper types",id:"json-wrapper-types",level:3},{value:"Base64VecU8",id:"base64vecu8",level:3}];function p(e){const n={a:"a",code:"code",h1:"h1",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"serialization-protocols",children:"Serialization Protocols"}),"\n",(0,r.jsxs)(n.p,{children:["Serialization formats within the SDK define how data structures are translated into bytes which are needed for passing data into methods of the smart contract or storing data in state. For the case of method parameters, ",(0,r.jsx)(n.a,{href:"https://www.json.org/json-en.html",children:"JSON"})," (default) and ",(0,r.jsx)(n.a,{href:"https://borsh.io/",children:"Borsh"})," are supported with the SDK and for storing data on-chain Borsh is used."]}),"\n",(0,r.jsx)(n.p,{children:"The qualities of JSON and Borsh are as follows:"}),"\n",(0,r.jsx)(n.p,{children:"JSON:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Human-readable"}),"\n",(0,r.jsx)(n.li,{children:"Self-describing format (don't need to know the underlying type)"}),"\n",(0,r.jsx)(n.li,{children:"Easy interop with JavaScript"}),"\n",(0,r.jsx)(n.li,{children:"Less efficient size and (de)serialization"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Borsh:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compact, binary format that's efficient for serialized data size"}),"\n",(0,r.jsx)(n.li,{children:"Need to know data format or have a schema to deserialize data"}),"\n",(0,r.jsx)(n.li,{children:"Strict and canonical binary representation"}),"\n",(0,r.jsx)(n.li,{children:"Fast and less overhead in most cases"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"In general, JSON will be used for contract calls and cross-contract calls for a better DevX, where Borsh can be used to optimize using less gas by having smaller parameter serialization and less deserialization computation within the contract."}),"\n",(0,r.jsx)(n.h3,{id:"overriding-serialization-protocol-default",children:"Overriding Serialization Protocol Default"}),"\n",(0,r.jsx)(n.p,{children:"The result and parameter serialization can be opted into separately, but all parameters must be of the same format (can't serialize some parameters as borsh and others as JSON). An example of switching both the result and parameters to borsh is as follows:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"#[result_serializer(borsh)]\npub fn sum_borsh(#[serializer(borsh)] a: u32, #[serializer(borsh)] b: u32) -> u32 {\n    a + b\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Where the ",(0,r.jsx)(n.code,{children:"result_serializer(borsh)"})," annotation will override the default result serialization protocol from JSON to borsh and the ",(0,r.jsx)(n.code,{children:"serializer(borsh)"})," annotations will override the parameter serialization."]}),"\n",(0,r.jsx)(n.h4,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(n.p,{children:["A simple demonstration of getting a ",(0,r.jsx)(n.a,{href:"https://borsh.io",children:"Borsh-serialized"}),", base64-encoded value from a unit test:"]}),"\n",(0,r.jsx)(l.Ey,{language:"rust",start:"93",end:"104",url:"https://github.com/mikedotexe/rust-status-message/blob/b83c5126fdbe0f19bc904e547fda0bb12c2ea133/src/lib.rs"}),"\n",(0,r.jsxs)(n.p,{children:["The following snippet shows a simple function that takes this value from a frontend or CLI. Note: this method doesn't have a return value, so the ",(0,r.jsx)(n.code,{children:"#[result_serializer(borsh)]"})," isn't needed."]}),"\n",(0,r.jsx)(l.Ey,{language:"rust",start:"40",end:"42",url:"https://github.com/mikedotexe/rust-status-message/blob/b83c5126fdbe0f19bc904e547fda0bb12c2ea133/src/lib.rs"}),"\n",(0,r.jsx)(n.p,{children:"Note that this is using this simple struct:"}),"\n",(0,r.jsx)(l.Ey,{language:"rust",start:"13",end:"17",url:"https://github.com/mikedotexe/rust-status-message/blob/b83c5126fdbe0f19bc904e547fda0bb12c2ea133/src/lib.rs"}),"\n",(0,r.jsx)(n.p,{children:"To call this with NEAR CLI, use a command similar to this:"}),"\n",(0,r.jsxs)(s.Z,{className:"language-tabs",groupId:"code-tabs",children:[(0,r.jsx)(i.Z,{value:"near-cli",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"near call rust-status-message.demo.testnet set_status_borsh --base64 'DAAAAEFsb2hhIGhvbnVhIQ==' --accountId demo.testnet\n"})})}),(0,r.jsx)(i.Z,{value:"near-cli-rs",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"near contract call-function as-transaction rust-status-message.demo.testnet set_status_borsh base64-args 'DAAAAEFsb2hhIGhvbnVhIQ==' prepaid-gas '30 TeraGas' attached-deposit '0 NEAR' sign-as demo.testnet network-config testnet sign-with-keychain send\n"})})})]}),"\n",(0,r.jsxs)(n.p,{children:["See more details in ",(0,r.jsx)(n.a,{href:"https://gist.github.com/mfornet/d8a94af333a68d67affd8cb78464c7c0",children:"this GitHub gist"})," from ",(0,r.jsx)(n.a,{href:"https://gist.github.com/mfornet",children:"Marcelo"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"json-wrapper-types",children:"JSON wrapper types"}),"\n",(0,r.jsxs)(n.p,{children:["To help with serializing certain types to JSON which have unexpected or inefficient default formats, there are some wrapper types in ",(0,r.jsx)(n.a,{href:"https://docs.rs/near-sdk/3.1.0/near_sdk/json_types/index.html",children:(0,r.jsx)(n.code,{children:"near_sdk::json_types"})})," that can be used."]}),"\n",(0,r.jsxs)(n.p,{children:["Because JavaScript only supports integers to value ",(0,r.jsx)(n.code,{children:"2^53 - 1"}),", you will lose precision if deserializing the JSON integer is above this range. To counteract this, you can use the ",(0,r.jsx)(n.code,{children:"I64"}),", ",(0,r.jsx)(n.code,{children:"U64"}),", ",(0,r.jsx)(n.code,{children:"I128"}),", and ",(0,r.jsx)(n.code,{children:"U128"})," in place of the native types for these parameters or result to serialize the value as a string. By default, all integer types will serialize as an integer in JSON."]}),"\n",(0,r.jsxs)(n.p,{children:["You can convert from ",(0,r.jsx)(n.code,{children:"U64"})," to ",(0,r.jsx)(n.code,{children:"u64"})," and back using ",(0,r.jsx)(n.code,{children:"std::convert::Into"}),", e.g."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"#[near_bindgen]\nimpl Contract {\n    pub fn mult(&self, a: U64, b: U64) -> U128 {\n        let a: u64 = a.into();\n        let b: u64 = b.into();\n        let product = u128::from(a) * u128::from(b);\n        product.into()\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can also access inner values and using ",(0,r.jsx)(n.code,{children:".0"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-diff",children:" #[near_bindgen]\n impl Contract {\n     pub fn mult(&self, a: U64, b: U64) -> U128 {\n-        let a: u64 = a.into();\n+        let a = a.0;\n-        let b: u64 = b.into();\n+        let b = b.0;\n         let product = u128::from(a) * u128::from(b);\n         product.into()\n     }\n }\n"})}),"\n",(0,r.jsxs)(n.p,{children:["And you can cast the lower-case ",(0,r.jsx)(n.code,{children:"u"})," variants to upper-case ",(0,r.jsx)(n.code,{children:"U"})," variants using ",(0,r.jsx)(n.code,{children:"U64(...)"})," and ",(0,r.jsx)(n.code,{children:"U128(...)"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-diff",children:" #[near_bindgen]\n impl Contract {\n     pub fn mult(&self, a: U64, b: U64) -> U128 {\n         let a = a.0;\n         let b = b.0;\n         let product = u128::from(a) * u128::from(b);\n-        product.into()\n+        U128(product)\n     }\n }\n"})}),"\n",(0,r.jsx)(n.p,{children:"Combining it all:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"#[near_bindgen]\nimpl Contract {\n    pub fn mult(&self, a: U64, b: U64) -> U128 {\n        U128(u128::from(a.0) * u128::from(b.0))\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Although there are these JSON wrapper types included with the SDK, any custom type can be used, as long as it implements ",(0,r.jsx)(n.a,{href:"https://serde.rs/",children:(0,r.jsx)(n.code,{children:"serde"})})," serialize and deserialize respectively. All of these types just override the JSON format and will have a consistent ",(0,r.jsx)(n.code,{children:"borsh"})," serialization and deserialization as the inner types."]}),"\n",(0,r.jsx)(n.h3,{id:"base64vecu8",children:"Base64VecU8"}),"\n",(0,r.jsxs)(n.p,{children:["Another example of a type you may want to override the default serialization of is ",(0,r.jsx)(n.code,{children:"Vec<u8>"})," which represents bytes in Rust. By default, this will serialize as an array of integers, which is not compact and very hard to use. There is a wrapper type ",(0,r.jsx)(n.a,{href:"https://docs.rs/near-sdk/3.1.0/near_sdk/json_types/struct.Base64VecU8.html",children:(0,r.jsx)(n.code,{children:"Base64VecU8"})})," which serializes and deserializes to a ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Base64",children:"Base-64"})," string for more compact JSON serialization."]}),"\n",(0,r.jsx)(n.p,{children:"Example here:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:"#[near_bindgen]\n#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]\npub struct Contract {\n    // Notice, internally we store `Vec<u8>` \n    pub data: Vec<u8>,\n}\n#[near_bindgen]\nimpl Contract {\n    #[init]\n    pub fn new(data: Base64VecU8) -> Self {\n        Self {\n            data: data.into(),\n        }\n    }\n    pub fn get_data(self) -> Base64VecU8 {\n        self.data.into()\n    }\n}\n"})})]})}function f(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},85162:(e,n,a)=>{a.d(n,{Z:()=>i});a(67294);var r=a(36905);const t={tabItem:"tabItem_Ymn6"};var s=a(85893);function i(e){var n=e.children,a=e.hidden,i=e.className;return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.Z)(t.tabItem,i),hidden:a,children:n})}},74866:(e,n,a)=>{a.d(n,{Z:()=>w});var r=a(67294),t=a(36905),s=a(12466),i=a(16550),l=a(20469),o=a(91980),c=a(67392),u=a(50012);function d(e){var n,a;return null!=(n=null==(a=r.Children.toArray(e).filter((function(e){return"\n"!==e})).map((function(e){if(!e||(0,r.isValidElement)(e)&&((n=e.props)&&"object"==typeof n&&"value"in n))return e;var n;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:a.filter(Boolean))?n:[]}function h(e){var n=e.values,a=e.children;return(0,r.useMemo)((function(){var e=null!=n?n:function(e){return d(e).map((function(e){var n=e.props;return{value:n.value,label:n.label,attributes:n.attributes,default:n.default}}))}(a);return function(e){var n=(0,c.l)(e,(function(e,n){return e.value===n.value}));if(n.length>0)throw new Error('Docusaurus error: Duplicate values "'+n.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[n,a])}function p(e){var n=e.value;return e.tabValues.some((function(e){return e.value===n}))}function f(e){var n=e.queryString,a=void 0!==n&&n,t=e.groupId,s=(0,i.k6)(),l=function(e){var n=e.queryString,a=void 0!==n&&n,r=e.groupId;if("string"==typeof a)return a;if(!1===a)return null;if(!0===a&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=r?r:null}({queryString:a,groupId:t});return[(0,o._X)(l),(0,r.useCallback)((function(e){if(l){var n=new URLSearchParams(s.location.search);n.set(l,e),s.replace(Object.assign({},s.location,{search:n.toString()}))}}),[l,s])]}function b(e){var n,a,t,s,i=e.defaultValue,o=e.queryString,c=void 0!==o&&o,d=e.groupId,b=h(e),m=(0,r.useState)((function(){return function(e){var n,a=e.defaultValue,r=e.tabValues;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(a){if(!p({value:a,tabValues:r}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+a+'" but none of its children has the corresponding value. Available values are: '+r.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return a}var t=null!=(n=r.find((function(e){return e.default})))?n:r[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:i,tabValues:b})})),g=m[0],v=m[1],x=f({queryString:c,groupId:d}),j=x[0],y=x[1],w=(n=function(e){return e?"docusaurus.tab."+e:null}({groupId:d}.groupId),a=(0,u.Nk)(n),t=a[0],s=a[1],[t,(0,r.useCallback)((function(e){n&&s.set(e)}),[n,s])]),z=w[0],N=w[1],S=function(){var e=null!=j?j:z;return p({value:e,tabValues:b})?e:null}();return(0,l.Z)((function(){S&&v(S)}),[S]),{selectedValue:g,selectValue:(0,r.useCallback)((function(e){if(!p({value:e,tabValues:b}))throw new Error("Can't select invalid tab value="+e);v(e),y(e),N(e)}),[y,N,b]),tabValues:b}}var m=a(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var v=a(85893);function x(e){var n=e.className,a=e.block,r=e.selectedValue,i=e.selectValue,l=e.tabValues,o=[],c=(0,s.o5)().blockElementScrollPositionUntilNextRender,u=function(e){var n=e.currentTarget,a=o.indexOf(n),t=l[a].value;t!==r&&(c(n),i(t))},d=function(e){var n,a=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":var r,t=o.indexOf(e.currentTarget)+1;a=null!=(r=o[t])?r:o[0];break;case"ArrowLeft":var s,i=o.indexOf(e.currentTarget)-1;a=null!=(s=o[i])?s:o[o.length-1]}null==(n=a)||n.focus()};return(0,v.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.Z)("tabs",{"tabs--block":a},n),children:l.map((function(e){var n=e.value,a=e.label,s=e.attributes;return(0,v.jsx)("li",Object.assign({role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:function(e){return o.push(e)},onKeyDown:d,onClick:u},s,{className:(0,t.Z)("tabs__item",g.tabItem,null==s?void 0:s.className,{"tabs__item--active":r===n}),children:null!=a?a:n}),n)}))})}function j(e){var n=e.lazy,a=e.children,t=e.selectedValue,s=(Array.isArray(a)?a:[a]).filter(Boolean);if(n){var i=s.find((function(e){return e.props.value===t}));return i?(0,r.cloneElement)(i,{className:"margin-top--md"}):null}return(0,v.jsx)("div",{className:"margin-top--md",children:s.map((function(e,n){return(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t})}))})}function y(e){var n=b(e);return(0,v.jsxs)("div",{className:(0,t.Z)("tabs-container",g.tabList),children:[(0,v.jsx)(x,Object.assign({},e,n)),(0,v.jsx)(j,Object.assign({},e,n))]})}function w(e){var n=(0,m.Z)();return(0,v.jsx)(y,Object.assign({},e,{children:d(e.children)}),String(n))}},77229:(e,n,a)=>{a.d(n,{Ey:()=>u,O2:()=>o,SQ:()=>c});a(67294);var r=a(74866),t=a(85162),s=a(95665),i=a.n(s),l=a(85893);function o(e){var n=e.children;return Array.isArray(n)||(n=[n]),(0,l.jsx)(r.Z,{className:"language-tabs",groupId:"code-tabs",children:n.map((function(e,n){return(0,l.jsx)(t.Z,{value:e.props.value,label:e.props.value,children:e})}))})}function c(e){var n=e.children,a=e.language;return Array.isArray(n)||(n=[n]),n=n.map((function(e){return function(e,n){var a=e.props,r=(a.children,a.url),t=a.start,s=a.end,i=a.fname;if(e.type===u)return u({url:r,start:t,end:s,language:n,fname:i});return e}(e,a)})),1==n.length?(0,l.jsx)(t.Z,{value:0,label:n[0].props.fname,children:n[0]}):(0,l.jsx)(r.Z,{className:"file-tabs",children:n.map((function(e,n){return(0,l.jsx)(t.Z,{value:n,label:e.props.fname,children:e})}))})}function u(e){var n=e.url,a=e.start,r=e.end,t=e.language,s=e.fname,o=n+"#";return a&&r&&(o+="L"+a+"-L"+r+"#"),(0,l.jsx)(i(),{language:t,fname:s,children:o})}}}]);